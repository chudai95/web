<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MQTT Connection Tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        .input-group { margin-bottom: 10px; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        input { padding: 5px; width: 250px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        #logs { background: #f4f4f4; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 20px; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>

    <h2>üîç C√îNG C·ª§ TEST K·∫æT N·ªêI MQTT</h2>

    <div class="input-group">
        <label>Host (Domain/IP):</label>
        <input type="text" id="host" value="duckdns.org">
    </div>
    <div class="input-group">
        <label>Port:</label>
        <input type="number" id="port" value="9443">
    </div>
    <div class="input-group">
        <label>Path (ƒê∆∞·ªùng d·∫´n):</label>
        <input type="text" id="path" value="/mqtt" placeholder="ƒê·ªÉ tr·ªëng ho·∫∑c /mqtt">
        <small>(Mosquitto th∆∞·ªùng l√† /mqtt ho·∫∑c r·ªóng)</small>
    </div>
    <div class="input-group">
        <label>Username:</label>
        <input type="text" id="user" value="admin_traiga">
    </div>
    <div class="input-group">
        <label>Password:</label>
        <input type="password" id="pass" value="">
    </div>
    <div class="input-group">
        <label>S·ª≠ d·ª•ng SSL (WSS):</label>
        <input type="checkbox" id="ssl" style="width: auto;"> <span style="color:red">Check n·∫øu d√πng WSS, b·ªè n·∫øu d√πng WS</span>
    </div>

    <button onclick="startTest()">B·∫ÆT ƒê·∫¶U TEST</button>

    <div id="logs">Log k·∫øt n·ªëi s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

    <script>
        let client = null;

        function log(msg, type = 'black') {
            const box = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div style="color:${type}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function startTest() {
            if (client) {
                try { client.disconnect(); } catch(e){}
                client = null;
            }

            const host = document.getElementById('host').value;
            const port = Number(document.getElementById('port').value);
            const path = document.getElementById('path').value;
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            const useSSL = document.getElementById('ssl').checked;

            document.getElementById('logs').innerHTML = ""; // X√≥a log c≈©
            
            const protocol = useSSL ? "wss://" : "ws://";
            log(`ƒêang th·ª≠ k·∫øt n·ªëi t·ªõi: <b>${protocol}${host}:${port}${path}</b>`, 'info');

            const clientId = "test_client_" + Math.random().toString(16).substr(2, 8);
            
            // C·∫•u h√¨nh Client v·ªõi Path (quan tr·ªçng)
            client = new Paho.MQTT.Client(host, port, path, clientId);

            const options = {
                timeout: 10, // Gi√¢y
                useSSL: useSSL,
                onSuccess: () => {
                    log("‚úÖ K·∫æT N·ªêI TH√ÄNH C√îNG!", "success");
                    log("Server ƒë√£ c·∫•u h√¨nh ƒë√∫ng WebSockets.", "success");
                },
                onFailure: (e) => {
                    log("‚ùå K·∫æT N·ªêI TH·∫§T B·∫†I!", "error");
                    log(`M√£ l·ªói: ${e.errorCode}`, "error");
                    log(`Chi ti·∫øt: ${e.errorMessage}`, "error");
                    analyzeError(e.errorCode, useSSL, port);
                }
            };

            if (user) {
                options.userName = user;
                options.password = pass;
            }

            try {
                client.connect(options);
            } catch (e) {
                log(`‚ùå L·ªói kh·ªüi t·∫°o: ${e.message}`, "error");
            }
        }

        function analyzeError(code, ssl, port) {
            if (code === 7 || code === 8) { // Socket Error
                log("------------------------------------------------", "black");
                log("üí° G·ª¢I √ù KH·∫ÆC PH·ª§C:", "blue");
                log("1. Ki·ªÉm tra xem Server ƒë√£ b·∫≠t 'protocol websockets' ch∆∞a? (N·∫øu ch·ªâ l√† 'protocol mqtt' th√¨ web kh√¥ng ch·∫°y ƒë∆∞·ª£c).", "black");
                log(`2. N·∫øu b·∫°n ƒëang d√πng SSL (WSS), ch·ª©ng ch·ªâ SSL c√≥ h·ª£p l·ªá kh√¥ng?`, "black");
                log(`3. Th·ª≠ ƒë·ªïi 'Path' th√†nh r·ªóng ho·∫∑c '/mqtt'.`, "black");
                if(ssl) {
                    log("4. B·∫°n ƒëang b·∫≠t SSL. H√£y th·ª≠ truy c·∫≠p tr·ª±c ti·∫øp: https://" + document.getElementById('host').value + ":" + port + " tr√™n tr√¨nh duy·ªát. N·∫øu tr√¨nh duy·ªát b√°o 'Kh√¥ng an to√†n', k·∫øt n·ªëi WSS s·∫Ω b·ªã ch·∫∑n.", "red");
                }
            }
        }
    </script>
</body>
</html>
