<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#2f3640">
  <title>üì° MQTT WebApp ‚Äì Dual Server Auto Connect</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f6fa;
      margin: 20px;
      color: #2f3640;
    }
    h2 {
      color: #273c75;
      margin-bottom: 10px;
    }
    p { margin: 4px 0; }
    #log {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.4em;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      background: #273c75;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
    }
    button:hover { background: #40739e; }
  </style>
</head>

<body>
  <h2>üêî MQTT WebApp ‚Äì Auto Failover</h2>
  <p><b>M√°y ch·ªß 1:</b> wss://dontseeme.zapto.org:9443/mqtt</p>
  <p><b>M√°y ch·ªß 2:</b> wss://mqtt.dontseeme.duckdns.org:9443/mqtt</p>
  <p><b>User:</b> noobies &nbsp;&nbsp; <b>Pass:</b> 123456</p>

  <button onclick="sendTest()">üì§ G·ª≠i th·ª≠ tin nh·∫Øn</button>
  <div id="log"></div>

<script>
const SERVERS = [
  "wss://mqtt.dontseeme.zapto.org:9443/mqtt",
  "wss://mqtt.dontseeme.duckdns.org:9443/mqtt"
];
const USER = "noobies";
const PASS = "123456";
const TOPIC = "test/aaa";

let current = 0;
let client = null;
let retrying = false;

function log(msg, color="#000") {
  const d = document.getElementById("log");
  const t = new Date().toLocaleTimeString();
  d.innerHTML += `<span style="color:${color}">[${t}] ${msg}</span><br>`;
  d.scrollTop = d.scrollHeight;
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

async function connectMQTT() {
  const broker = SERVERS[current];
  log(`üîó ƒêang k·∫øt n·ªëi ƒë·∫øn ${broker}`, "#2980b9");

  try {
    client = mqtt.connect(broker, {
      username: USER,
      password: PASS,
      protocolVersion: 4,
      connectTimeout: 4000,
      reconnectPeriod: 0, // ch√∫ng ta t·ª± ƒëi·ªÅu khi·ªÉn reconnect
      clean: true,
      clientId: "web_" + Math.random().toString(16).slice(2,8)
    });
  } catch(e) {
    log("‚ö†Ô∏è Kh√¥ng th·ªÉ kh·ªüi t·∫°o MQTT: " + e.message, "red");
    return retryFailover();
  }

  // Timeout n·∫øu kh√¥ng connect trong 6s
  const failTimer = setTimeout(() => {
    log(`‚è±Ô∏è Timeout k·∫øt n·ªëi ${broker}`, "red");
    try { client.end(true); } catch(e){}
  }, 6000);

  client.on("connect", () => {
    clearTimeout(failTimer);
    log(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng: ${broker}`, "green");
    client.subscribe(TOPIC, err => {
      if (err) log(`‚ùå L·ªói subscribe: ${err.message}`, "red");
      else log(`üì° ƒê√£ subscribe topic: ${TOPIC}`, "#27ae60");
    });
  });

  client.on("message", (topic, msg) => {
    log(`üì® Nh·∫≠n [${topic}]: ${msg.toString()}`, "#27ae60");
  });

  client.on("error", (err) => {
    clearTimeout(failTimer);
    log(`‚ö†Ô∏è L·ªói MQTT (${broker}): ${err.message}`, "red");
    retryFailover();
  });

  client.on("close", () => {
    clearTimeout(failTimer);
    if (!retrying) {
      log(`‚ùå M·∫•t k·∫øt n·ªëi: ${broker}`, "red");
      retryFailover();
    }
  });
}

async function retryFailover() {
  retrying = true;
  try { client.end(true); } catch(e){}
  await delay(500); // ƒë·∫£m b·∫£o WebSocket c≈© ƒë√≥ng ho√†n to√†n
  current = (current + 1) % SERVERS.length;
  log(`üîÅ Th·ª≠ chuy·ªÉn sang M√°y ch·ªß ${current + 1}`, "#8e44ad");
  retrying = false;
  connectMQTT();
}

function sendTest() {
  if (client && client.connected) {
    const msg = "Xin ch√†o MQTT ‚Äì " + new Date().toLocaleTimeString();
    client.publish(TOPIC, msg);
    log(`üì§ ƒê√£ g·ª≠i: ${msg}`, "#16a085");
  } else {
    log("‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi MQTT!", "red");
  }
}

window.addEventListener("load", connectMQTT);
</script>
</body>
</html>
