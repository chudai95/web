<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điều Khiển Quạt - MQTT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; text-align: center; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        
        /* Trạng thái */
        .status { padding: 10px; margin-bottom: 20px; border-radius: 5px; font-weight: bold; color: white; }
        .status.disconnected { background-color: #e74c3c; } /* Đỏ */
        .status.connected { background-color: #2ecc71; }    /* Xanh lá */
        .status.connecting { background-color: #f1c40f; color: black; } /* Vàng */

        /* Input form */
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Nút bấm */
        .btn { border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 5px; transition: 0.3s; width: 45%; color: white; }
        .btn-connect { background-color: #3498db; width: 100%; margin-top: 10px; }
        .btn-on { background-color: #2ecc71; opacity: 0.5; pointer-events: none; } /* Mờ khi chưa kết nối */
        .btn-off { background-color: #e74c3c; opacity: 0.5; pointer-events: none; }

        /* Khi đã kết nối thì nút sáng lên */
        .active .btn-on { opacity: 1; pointer-events: auto; }
        .active .btn-off { opacity: 1; pointer-events: auto; }

        #log { margin-top: 20px; font-size: 12px; color: #666; text-align: left; height: 100px; overflow-y: scroll; border-top: 1px solid #eee; padding-top: 5px;}
    </style>
</head>
<body>

<div class="container" id="main-interface">
    <h2>Điều Khiển Quạt</h2>
    
    <div id="status-display" class="status disconnected">Đã ngắt kết nối</div>

    <div id="login-area">
        <div class="input-group">
            <label>MQTT User:</label>
            <input type="text" id="mqtt-user" placeholder="Nhập user MQTT">
        </div>
        <div class="input-group">
            <label>MQTT Password:</label>
            <input type="password" id="mqtt-pass" placeholder="Nhập pass MQTT">
        </div>
        <button class="btn btn-connect" onclick="startConnect()">KẾT NỐI</button>
    </div>

    <hr>

    <div id="control-area">
        <button class="btn btn-on" onclick="sendControl('ON')">BẬT QUẠT</button>
        <button class="btn btn-off" onclick="sendControl('OFF')">TẮT QUẠT</button>
    </div>

    <div id="log">Logs:<br></div>
</div>

<script>
    // --- CẤU HÌNH SERVER ---
    const mqtt_host = "mqtt.dontseeme.duckdns.org"; 
    const mqtt_port = 9443; 
    const mqtt_path = "/mqtt"; // Đường dẫn bắt buộc của EMQX Websocket
    const use_ssl = true;      // Bắt buộc True cho GitHub Pages
    const topic_control = "home/quat/control"; // Topic gửi lệnh
    const topic_status = "home/quat/status";   // Topic nhận trạng thái (nếu có)

    let client = null;

    function log(msg) {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += msg + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
    }

    // Hàm bắt đầu kết nối
    function startConnect() {
        const user = document.getElementById('mqtt-user').value;
        const pass = document.getElementById('mqtt-pass').value;

        if (!user || !pass) {
            alert("Vui lòng nhập User và Password MQTT!");
            return;
        }

        updateStatus("connecting");
        
        // Tạo Client ID ngẫu nhiên
        const clientId = "web_" + parseInt(Math.random() * 100000);
        
        // Khởi tạo đối tượng Paho Client
        // Cú pháp: host, port, path, clientId
        client = new Paho.MQTT.Client(mqtt_host, mqtt_port, mqtt_path, clientId);

        // Cài đặt các hàm callback
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Tùy chọn kết nối
        const options = {
            useSSL: use_ssl,
            userName: user,
            password: pass,
            onSuccess: onConnect,
            onFailure: onFail,
            keepAliveInterval: 30,
            timeout: 10
        };

        log(`Đang kết nối tới ${mqtt_host}:${mqtt_port}${mqtt_path}...`);
        try {
            client.connect(options);
        } catch (e) {
            log("Lỗi code: " + e);
        }
    }

    // Khi kết nối thành công
    function onConnect() {
        updateStatus("connected");
        log("Kết nối THÀNH CÔNG!");
        
        // Kích hoạt nút bấm
        document.getElementById('main-interface').classList.add('active');
        // Ẩn khung đăng nhập cho gọn (tùy chọn)
        document.getElementById('login-area').style.display = 'none';

        // Subscribe để nhận phản hồi từ thiết bị (nếu cần)
        client.subscribe(topic_status);
    }

    // Khi kết nối thất bại
    function onFail(responseObject) {
        updateStatus("disconnected");
        log("Lỗi kết nối: " + responseObject.errorMessage);
        alert("Không kết nối được! Kiểm tra lại User/Pass hoặc Server.");
    }

    // Khi bị mất kết nối đột ngột
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            updateStatus("disconnected");
            log("Mất kết nối: " + responseObject.errorMessage);
            document.getElementById('main-interface').classList.remove('active');
            document.getElementById('login-area').style.display = 'block';
        }
    }

    // Khi nhận được tin nhắn từ Server
    function onMessageArrived(message) {
        log("Nhận tin: " + message.payloadString + " (Topic: " + message.destinationName + ")");
    }

    // Hàm gửi lệnh điều khiển
    function sendControl(cmd) {
        if (!client || !client.isConnected()) {
            alert("Chưa kết nối MQTT!");
            return;
        }
        
        // Tạo tin nhắn
        // cmd sẽ là 'ON' hoặc 'OFF'
        const message = new Paho.MQTT.Message(cmd);
        message.destinationName = topic_control;
        client.send(message);
        log("Đã gửi lệnh: " + cmd);
    }

    // Hàm cập nhật giao diện trạng thái
    function updateStatus(state) {
        const statusDiv = document.getElementById('status-display');
        statusDiv.className = 'status ' + state;
        if(state === 'connected') statusDiv.innerHTML = "ĐÃ KẾT NỐI";
        else if(state === 'connecting') statusDiv.innerHTML = "ĐANG KẾT NỐI...";
        else statusDiv.innerHTML = "ĐÃ NGẮT KẾT NỐI";
    }
</script>

</body>
</html>
